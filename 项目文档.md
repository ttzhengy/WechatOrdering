# 项目文档

## 项目简介和需求

### 名称

中小企业微信点餐系统

### 产品介绍

消费者使用移动端的微信小程序可以进行浏览商品、操作订单等操作。商家可以通过登录后台业务管理系统，管理商品的类目和具体信息，处理消费者订单等。

### 技术要求

- SpringBoot
- MyBatis
- MySQL
- Redis

## 项目细节

### 项目结构

### 数据库结构

1. 商品类目表：与商品信息表是一对多关系
   - 类目id：主键
   - 类目名称
   - 类目种类
2. 商品信息表：与订单细节表是一对多关系
   - 商品id：主键
   - 商品名称
   - 商品单价
   - 商品库存
   - 商品描述
   - 商品图片（url）
   - 商品状态：0上架，1下架。默认0
   - 商品类目：外键—category_id—》商品类目表
3. 订单主表：与订单细节表是一对多关系
   - 订单id：主键
   - 买家名称
   - 买家电话
   - 买家地址
   - 买家openid
   - 订单总额
   - 订单状态：0新下单，1已完成，2取消订单。默认0
   - 支付状态：0未支付，1已支付。默认0
   - // TODO 订单细节表list
4. 订单细节表
   - 细节表id：主键
   - 订单主表id：外键—order_id—》订单主表
   - 商品id：外键—product_id—》商品信息表
   - 商品名称
   - 商品价格
   - 商品数量
   - 商品图片
5. 商家登录信息表

### 数据持久（Dao）层

#### 商品类目

ProductCategoryDao接口

- 根据id查询单个商品类目：ProductCategory selectById(int id)
- 根据商品类目编号集合，查询包含的商品类目：List\<ProductCategory> selectByType(List\<Integer> types)
- 插入新商品类目，主键自增并自动获取：void insertProductCategory(ProductCategory productCategory)
- 根据id修改某个商品类目：void updateProductCategory(ProductCategory productCategory)

#### 商品信息

ProductInfoDao接口

- 根据id查询单个商品：ProductInfo selectById(String id)
- 根据商品类目，查询包含的商品：List\<ProductInfo> selectByCategoryType(Integer type)
- 根据商品状态，查询包含的商品：List\<ProductInfo> selectByProductStatus(Integer status)
- 增加商品：boolean insertProductInfo(ProductInfo productInfo)
- 根据id修改某个商品：boolean updateProductInfo(ProductInfo productInfo)

#### 订单主表

OrderMasterDao接口，需要pageHelper插件分页

- 根据id查询订单主表：OrderMaster selectById(String id);
- 根据买家openid查询该买家的订单：List\<OrderMaster> selectByBuyerOpenId(String buyerOpenId);
- 增加订单：boolean insertOrderMaster(OrderMaster orderMaster);
- 根据id修改某个订单：boolean updateOrderMaster(OrderMaster orderMaster);

#### 订单细节表

OrderDetailDao接口

- 根据id查询订单细节表：OrderDetail selectById(String id);
- 根据订单主表id，查询该主表下的订单细节表：List\<OrderDetail> selectByOrderId(String orderId);
- 根据商品id，查询包含该商品的订单细节表：List\<OrderDetail> selectByProductId(String productId);
- 增加订单细节：boolean insertOrderDetail(OrderDetail orderDetail);
- 根据id修改订单细节：boolean updateOrderDetail(OrderDetail orderDetail);

### 业务逻辑（Service）

#### 商品类目

##### 接口

CategoryService

- 查询类目：selectById
- 查询所有类目：selectAll
- 根据列表查询类目：selectByCategoryTypeIn
- 增加类目：insert
- 修改类目信息：update

##### 实现类

CategoryServiceImpl

#### 商品细节

##### 接口

ProductService

- 查询商品：selectById
- 查询所有商品：selectAll
- 查询所有上架商品：selectAllOnSale
- 根据类目列表查询商品：selectByCategoryTypeIn
- 增加商品：insert
- 修改商品信息：update

##### 实现类

ProductServiceImpl

#### 订单主表

##### 接口

OrderService

- 创建订单：
- 查询订单：
- 查询订单列表：
- 取消订单：
- 支付订单：
- 完成订单：

##### 实现类

OrderServiceImpl

- 创建订单：
  - 查询商品（数量、价格等）
  - 判断库存，计算总价
  - 写入订单数据库（orderMaster和orderDetail）
  - 扣除库存

### Controller层

本项目都使用RESTful风格的接口，所以控制器类使用的标注都是`@RestController`

访问路径配置

```
server：
  servlet
    context-path= /yatorder
```

#### 买家商品

BuyerProductController

类请求路径

```
../buyer/product
```

- ResultVO list()：get，返回所有类目及所属商品

  ```
  .../list
  ```

  - 查询所有上架商品
  - 根据商品列表得到类目列表（使用stream和lambda），再用类目列表查询类目信息
  - 数据拼装（BeanUtils，spring提供）
  - // TODO ResultVOUtil，返回VO对象

- 

### 视图对象（View Object）

ResultVO

- String code
- String msg
- T data

CategoryVO

- String categoryName：json property name
- Integer categoryType：json property type
- List\<ProductVO> product：json property foods

ProductVO

- String productId：json property id
- String productName：json property name
- BigDecimal productPrice：json property price
- String productDescription：json property description
- String productIcon：json property icon

### 异常类

SellException extends RuntimeException

### 枚举类

ResultEnum：返回给前端的错误信息

- PRODUCT_NOT_EXISTS(10,"商品不存在")

